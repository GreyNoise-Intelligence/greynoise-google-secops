graph.metadata.vendor_name = "GreyNoise Intelligence"
graph.metadata.product_name = "GreyNoise Intelligence"
$ip = graph.entity.ip
$classification = graph.metadata.threat.threat_verdict
$bot = strings.to_upper(graph.metadata.threat.detection_fields["bot"])
$tor = strings.to_upper(graph.metadata.threat.detection_fields["tor"])
$spoofable = strings.to_upper(graph.metadata.threat.detection_fields["spoofable"])
$vpn_Service = if(graph.metadata.threat.detection_fields["vpn"]= "true", graph.metadata.threat.detection_fields["vpn_service"], "-")
$time = timestamp.get_timestamp(graph.metadata.collected_timestamp.seconds, "%Y-%m-%d %H:%M:%S")
$first_seen_date = timestamp.get_timestamp(graph.metadata.threat.first_discovered_time.seconds, "%Y-%m-%d")
$category = graph.additional.fields["network_category"]
$category = /.*/
graph.entity.asset.vulnerabilities.cve_id = /.*/
match:
    $ip, $classification, $category, $bot, $tor, $vpn_Service, $spoofable, $first_seen_date
outcome:
    $all_cves = re.replace((arrays.join_string(array_distinct(if(graph.entity.asset.vulnerabilities.cve_id!="", graph.entity.asset.vulnerabilities.cve_id, "-")),", ")), "(, -)|(-, )","")
    $last_seen = window.last(graph.metadata.collected_timestamp.seconds, $time)
order:
    $last_seen desc
limit:
    10000